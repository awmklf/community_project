<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="community.board.service.BoardDAO">


<!-- <resultMap type="BoardVO" id="board"> -->
<!-- 	<result property="boardId" column="BOARD_ID"/> -->
<!-- 	<result property="category" column="CATEGORY"/> -->
<!-- 	<result property="boardSj" column="BOARD_SJ"/> -->
<!-- 	<result property="boardCn" column="BOARD_CN"/> -->
<!-- 	<result property="inqireCo" column="INQIRE_CO"/> -->
<!-- 	<result property="recommendCnt" column="RECOMMEND_CNT"/> -->
<!-- 	<result property="creatIp" column="CREAT_IP"/> -->
<!-- 	<result property="isNotice" column="IS_NOTICE"/> -->
<!-- 	<result property="othbcAt" column="OTHBC_AT"/> -->
<!-- 	<result property="useAt" column="USE_AT"/> -->
<!-- 	<result property="atchFileId" column="ATCH_FILE_ID"/> -->
<!-- 	<result property="frstRegistPnttm" column="FRST_REGIST_PNTTM"/> -->
<!-- 	<result property="registerId" column="REGISTER_ID"/> -->
<!-- 	<result property="lastUpdtPnttm" column="LAST_UPDT_PNTTM"/> -->
<!-- 	<result property="nickname" column="NICKNAME"/> -->
<!-- </resultMap> -->


<!-- 게시글 목록 조건절 -->
<sql id="selectBoardListWhere">
	<where>
		A.USE_AT = 'Y'
		<choose>
		<when test='isNotice == "Y"'>
			AND A.IS_NOTICE = 'Y'
		</when>
		<otherwise>
			<if test='searchCondition != null and searchCondition !="" '>
			<choose>
				<when test='searchCondition == "0"'>
					AND A.BOARD_SJ LIKE concat('%', #{searchKeyword}, '%')
				</when>
				<when test='searchCondition == "1"'>
					AND A.BOARD_CN LIKE concat('%', #{searchKeyword}, '%')
				</when>
				<when test='searchCondition == "2"'>
					AND B.USER_ID LIKE concat('%', #{searchKeyword}, '%')
				</when>
			</choose>
			</if>
		</otherwise>
		</choose>
	</where>
</sql>

<!-- 게시글 목록 조회 쿼리 -->
<select id="selectBoardList" resultType="BoardVO">
	SELECT 
		A.BOARD_ID
		, A.CATEGORY
		, A.BOARD_SJ
		, A.BOARD_CN
		, A.INQIRE_CO
		, A.RECOMMEND_CNT
		, A.CREAT_IP
		, A.IS_NOTICE
		, A.OTHBC_AT
		, A.USE_AT
		, A.ATCH_FILE_ID
		, A.FRST_REGIST_PNTTM
		, A.REGISTER_ID
		, B.NICKNAME
	FROM BOARD A 
		JOIN USERINFO B ON A.REGISTER_ID = B.USER_ID
	<include refid="selectBoardListWhere"/>
	ORDER BY A.FRST_REGIST_PNTTM DESC
	<if test='isNotice != "Y"'>
		LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
	</if>
</select>

<!-- 게시물 수 조회 쿼리 -->
<select id="selectBoardListCnt" resultType="java.lang.Integer">
	SELECT 
		COUNT(*) CNT
	FROM BOARD A
		JOIN USERINFO B ON A.REGISTER_ID = B.USER_ID
	<include refid="selectBoardListWhere"/>
</select>


<!-- 게시글 조회수 증가 쿼리 -->
<update id="updateViewCnt" parameterType="BoardVO">
	UPDATE BOARD SET 
			INQIRE_CO = INQIRE_CO+1 
	WHERE BOARD_ID = #{boardId}
</update>

<!-- 게시글 내용 조회 쿼리 -->
<select id="selectBoard" resultType="BoardVO">
	SELECT
		BOARD_ID
		, CATEGORY
		, BOARD_SJ
		, BOARD_CN
		, INQIRE_CO
		, CREAT_IP
		, OTHBC_AT
		, USE_AT
		, ATCH_FILE_ID
		, FRST_REGIST_PNTTM
		, REGISTER_ID
		, RECOMMEND_CNT
		, IS_NOTICE
		, NICKNAME
	FROM BOARD 
		JOIN USERINFO ON REGISTER_ID = USER_ID
	WHERE BOARD_ID = #{boardId}
	 		AND USE_AT = 'Y'
</select>

<!-- 마지막 게시글 번호 조회 쿼리 -->
<select id="selectLastBoardId">
	SELECT 
		MAX(BOARD_ID) 
	FROM board
</select>


<!-- 게시글 작성 쿼리 -->
<insert id="insertBoard">
	INSERT INTO BOARD (
		BOARD_ID
		, CATEGORY
		, BOARD_SJ
		, BOARD_CN
		, INQIRE_CO
		, CREAT_IP
		, OTHBC_AT
		, USE_AT
		, ATCH_FILE_ID
		, FRST_REGIST_PNTTM
		, LAST_UPDT_PNTTM
		, REGISTER_ID
		, RECOMMEND_CNT
		, IS_NOTICE
	) VALUES(
		#{boardId}
		, #{category}
		, #{boardSj}
		, #{boardCn}
		, 0
		, #{creatIp}
		, #{othbcAt}
		, 'Y'
		, NULL
		, NOW()
		, NOW()
		, #{registerId}
		, 0
		, #{isNotice}
	)
</insert>

<!-- 게시글 수정 쿼리 -->
<update id="updateBoard">
	UPDATE BOARD 
	SET
		CATEGORY = #{category}
		, BOARD_SJ = #{boardSj}
		, BOARD_CN  = #{boardCn}
	<if test='mngAt == "Y"'>
		, IS_NOTICE  = #{isNotice}
	</if>
	<if test='category == 4'>
		, OTHBC_AT  = #{othbcAt}
	</if>
		, LAST_UPDT_PNTTM  = NOW()
	WHERE 
		BOARD_ID = #{boardId}
		<if test='mngAt != "Y"'>
			AND REGISTER_ID = #{userId}
		</if>
</update>

<!-- 게시글 삭제 쿼리 -->
<update id="deleteBoard">
	UPDATE BOARD 
	SET USE_AT = 'N'
	WHERE 
		BOARD_ID = #{boardId}
	<if test='mngAt != "Y"'>
		AND REGISTER_ID = #{userId}
	</if>
</update>

<!-- 게시글 추천수 증가 쿼리 -->
<update id="updateBoardRecCnt">
	UPDATE BOARD SET 
			RECOMMEND_CNT = RECOMMEND_CNT+1 
	WHERE BOARD_ID = #{boardId}
</update>

<!-- 게시글 추천수 조회 쿼리 -->
<select id="viewBoardRecCnt" resultType="java.lang.Integer">
	SELECT
		RECOMMEND_CNT
	FROM BOARD 
	WHERE BOARD_ID = #{boardId}
</select>

<!-- 게시글 추천 상세 조회 쿼리 -->
<select id="selectRecommend" resultType="BoardVO">
	SELECT
		USER_ID 
		, BOARD_ID 
		, NUM_RECOMMENDATIONS
	FROM RECOMMEND
	WHERE BOARD_ID = #{boardId}
		AND USER_ID = #{userId}
</select>
<!-- 게시글 추천 상세 추가 쿼리 -->
<insert id="insertRecommend">
	INSERT INTO RECOMMEND (
		USER_ID 
		, BOARD_ID 
		, NUM_RECOMMENDATIONS 
	) VALUES (
		#{userId}
		, #{boardId}
		, 1
	)
</insert>
<!-- 게시글 추천 상세 갱신 쿼리 -->
<update id="updateRecommend">
	UPDATE RECOMMEND SET 
		NUM_RECOMMENDATIONS = NUM_RECOMMENDATIONS+1
	WHERE BOARD_ID = #{boardId}
		AND USER_ID = #{userId}
</update>

</mapper>